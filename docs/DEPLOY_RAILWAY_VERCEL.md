# ðŸš€ Deployment Guide - Railway + Vercel

## Overview

This guide will help you deploy the Dormitory Management System using:
- **Railway** - Backend, Database, Redis
- **Vercel** - Frontend (Next.js)

**Total Cost:** FREE (with Railway $5/month credit)

---

## Prerequisites

- GitHub account
- Railway account (sign up at railway.app)
- Vercel account (sign up at vercel.com)
- LINE Developer account (for LINE integration)

---

## Part 1: Deploy Backend to Railway

### Step 1: Create Railway Project

1. Go to [railway.app](https://railway.app)
2. Click "Start a New Project"
3. Choose "Deploy from GitHub repo"
4. Select your `dormitory` repository
5. Choose `backend` folder as root

### Step 2: Add PostgreSQL Database

1. In your Railway project, click "+ New"
2. Select "Database" â†’ "PostgreSQL"
3. Wait for provisioning
4. Copy the `DATABASE_URL` from the "Connect" tab

### Step 3: Add Redis

1. Click "+ New" again
2. Select "Database" â†’ "Redis"
3. Wait for provisioning
4. Copy the `REDIS_URL` from the "Connect" tab

### Step 4: Configure Environment Variables

In Railway backend service, add these variables:

```env
# Database (auto-generated by Railway)
DATABASE_URL=postgresql://... (Use Supabase connection pool string port 6543)
DIRECT_URL=postgresql://... (Use Supabase direct connection string port 5432)

# Redis (auto-generated by Railway)
REDIS_URL=redis://...

# JWT Secrets (generate strong secrets)
JWT_SECRET=your-very-long-secret-at-least-32-characters-here
JWT_REFRESH_SECRET=your-very-long-refresh-secret-at-least-32-characters-here

# Node Environment
NODE_ENV=production
PORT=3001

# LINE Integration
LINE_CHANNEL_ID=your-line-channel-id
LINE_CHANNEL_SECRET=your-line-channel-secret
LINE_ACCESS_TOKEN=your-line-access-token

# Supabase
SUPABASE_URL=your-supabase-url
SUPABASE_ANON_KEY=your-supabase-anon-key

# CORS (will be your Vercel URL)
CORS_ORIGIN=https://your-app.vercel.app
```

### Step 5: Configure Build Settings

In Railway backend service settings:

**Root Directory:** `backend`

**Build Command:**
```bash
npm install && npm run prisma:generate && npm run build
```

**Start Command:**
```bash
npm run prisma:migrate:deploy && npm start
```

### Step 6: Deploy

1. Click "Deploy"
2. Wait for build to complete
3. Copy your backend URL (e.g., `https://dormitory-backend-production.up.railway.app`)

### Step 7: Test Backend

```bash
curl https://your-backend-url.railway.app/api/health
```

Should return:
```json
{
  "status": "ok",
  "timestamp": "...",
  "checks": {
    "database": "healthy",
    "redis": "healthy"
  }
}
```

---

## Part 2: Deploy Frontend to Vercel

### Step 1: Connect GitHub to Vercel

1. Go to [vercel.com](https://vercel.com)
2. Click "Add New Project"
3. Import your `dormitory` repository
4. Select `frontend` as root directory

### Step 2: Configure Build Settings

**Framework Preset:** Next.js

**Root Directory:** `frontend`

**Build Command:** `npm run build`

**Output Directory:** `.next`

### Step 3: Add Environment Variables

```env
# Backend API URL (from Railway)
NEXT_PUBLIC_API_URL=https://your-backend-url.railway.app

# Node Environment
NODE_ENV=production
```

### Step 4: Deploy

1. Click "Deploy"
2. Wait for build to complete
3. Your app will be live at `https://your-app.vercel.app`

### Step 5: Update CORS in Railway

Go back to Railway backend and update:
```env
CORS_ORIGIN=https://your-app.vercel.app
```

---

## Part 3: Configure Custom Domain (Optional)

### For Vercel (Frontend)

1. Go to Project Settings â†’ Domains
2. Add your custom domain (e.g., `dormitory.yourdomain.com`)
3. Update DNS records as instructed

### For Railway (Backend)

1. Go to Service Settings â†’ Networking
2. Add custom domain (e.g., `api.yourdomain.com`)
3. Update DNS records

---

## Part 4: Setup LINE Webhook

1. Go to [LINE Developers Console](https://developers.line.biz/)
2. Select your channel
3. Go to "Messaging API" tab
4. Set Webhook URL to:
   ```
   https://your-backend-url.railway.app/api/line/webhook
   ```
5. Enable "Use webhook"
6. Verify webhook

---

## Part 5: Database Seeding (Optional)

### Option 1: Using Railway CLI

```bash
# Install Railway CLI
npm install -g @railway/cli

# Login
railway login

# Link to your project
railway link

# Run seed
railway run npm run prisma:seed
```

### Option 2: Using Prisma Studio

```bash
# Connect to Railway database
railway run npx prisma studio
```

Then manually add data through the UI.

---

## Monitoring & Logs

### Railway

- View logs: Project â†’ Service â†’ Logs
- View metrics: Project â†’ Service â†’ Metrics
- Database: Project â†’ PostgreSQL â†’ Data

### Vercel

- View logs: Project â†’ Deployments â†’ [Latest] â†’ Logs
- View analytics: Project â†’ Analytics

---

## Troubleshooting

### Backend won't start

**Check:**
1. Environment variables are set correctly
2. Database migrations ran successfully
3. Build completed without errors

**Solution:**
```bash
# In Railway, check logs
# Look for migration errors
# Manually run migrations if needed
railway run npx prisma migrate deploy
```

### Frontend can't connect to backend

**Check:**
1. `NEXT_PUBLIC_API_URL` is correct
2. CORS is configured properly
3. Backend is running

**Solution:**
```bash
# Test backend health
curl https://your-backend-url.railway.app/api/health

# Check CORS_ORIGIN in Railway
```

### Database connection issues

**Check:**
1. `DATABASE_URL` is correct
2. Database is running
3. Migrations completed

**Solution:**
```bash
# Check database status in Railway
# Restart database if needed
# Re-run migrations
```

---

## Cost Estimation

### Railway (Free Tier)

- **Credit:** $5/month
- **Usage:**
  - PostgreSQL: ~$2/month
  - Redis: ~$1/month
  - Backend: ~$2/month
- **Total:** ~$5/month (FREE with credit)

### Vercel (Free Tier)

- **Bandwidth:** 100GB/month
- **Builds:** 6000 minutes/month
- **Serverless Functions:** 100GB-hours
- **Total:** FREE

**Overall Cost: $0/month** (within free tiers)

---

## Scaling Up

When you need more resources:

### Railway

- **Starter:** $5/month (500MB RAM, 1GB storage)
- **Pro:** $20/month (8GB RAM, 100GB storage)

### Vercel

- **Pro:** $20/month (unlimited bandwidth)

---

## Security Checklist

- [ ] Change all default passwords
- [ ] Use strong JWT secrets (32+ characters)
- [ ] Enable SSL/HTTPS (automatic on Railway & Vercel)
- [ ] Configure CORS properly
- [ ] Set up environment variables correctly
- [ ] Enable rate limiting
- [ ] Review security headers

---

## Backup Strategy

### Database Backups

Railway provides automatic backups for paid plans.

**Manual Backup:**
```bash
# Using Railway CLI
railway run pg_dump $DATABASE_URL > backup.sql
```

**Restore:**
```bash
railway run psql $DATABASE_URL < backup.sql
```

---

## Next Steps

1. âœ… Deploy backend to Railway
2. âœ… Deploy frontend to Vercel
3. âœ… Configure environment variables
4. âœ… Setup LINE webhook
5. âœ… Test all features
6. ðŸ“ Update README with live demo link
7. ðŸ“ Add deployment badge to README

---

## Live Demo Links

Add these to your README:

```markdown
## ðŸŒ Live Demo

- **Frontend:** https://your-app.vercel.app
- **Backend API:** https://your-backend.railway.app
- **API Health:** https://your-backend.railway.app/api/health
```

---

## Support

If you encounter issues:

1. Check Railway logs
2. Check Vercel logs
3. Review [Troubleshooting Guide](./TROUBLESHOOTING.md)
4. Check Railway documentation
5. Check Vercel documentation
